# Notifications

## Phase 1: Encedo login

Before Encedo HEM performs any push notification enquiry first it needs to gather unique session key (a.k.a. login first). This session key (technically curve25519 public key) is valid 24h and is required to validate enquiry from mantated HEM.

```shell
curl -X POST "https://notify.encedo.com/hello"
     -H "Content-Type: application/json"
     -d '{"eid": "jnLU9Bk2XW/J7ExvfID+xq89rIGyONQgO9bpXvCYKhs="}
```

> The above command returns JSON structured like this:

```json
{
	"emp": "i+7QJDUbmmQ2Ek2Xmgq2lXrAQvCL1BGuA1ChfgMGnU4=",
	"eat": "1513780489"
}
```


### HTTP Request
`POST https://notify.encedo.com/hello`


### POST Parameters
Parameter | Description
--------- | -----------
eid | Base64 Encedo public key


### Response
Parameter | Description
--------- | -----------
emp | Ephemeral session key (curve25519) valid 24h
eat | Expiration timestamp of this ephemeral session key


### Status codes
Code | Meaning
---------- | -------
200 | OK
400 | Bad Request -- Missing arguments.
404 | Not Found -- The specified item could not be found.


<aside class="warning">Parameters to send as POST data need to be retrieved from Encedo HEM.</aside>

This Encedo HEM endpoint provides necessery data:

```shell
curl "https://encedokey.com/api/2FA/subscriptions"
```

> The above command returns JSON structured like this:

```json
{
	"eid": "jnLU9Bk2XW/J7ExvfID+xq89rIGyONQgO9bpXvCYKhs=",
	"lbl": "John Doe (john@example.pl)",
}
```






## Phase 2: Encedo notify request

Every request from Encedo HEM that requires Mobile App action needs to be routed to them. By calling this endpoint all registered apps will get a notification about pending enquiry. If <code>&lt;aid&gt;</code> is provided only that one mobile app will get notification, otherwise all registered.

```shell
curl -X POST "https://notify.encedo.com/notify"
     -H "Content-Type: application/json"
     -d '{"emp": "i+7QJDUbmmQ2Ek2Xmgq2lXrAQvCL1BGuA1ChfgMGnU4=",
          "sig": "2ivAugFoMOyAShnurRsgIVvBWHNzuwbzB/iKJnnxmuM=",
          "data": "eyIyRkEiOn...lVTIn19", 
          "eat": "1513780490"}
```

> The above command returns JSON structured like this:

```json
{
	"eventid": "xdA70t7sYLl6ZeMN71FCvJVL2K...O6jtLh7m70C"
}
```

### HTTP Request
`POST https://notify.encedo.com/notify`


### POST Parameters
Parameter | Description
--------- | -----------
emp | Ephemeral session key
data | Payload send by HEM
sig | Signature
eat | Expiration timestamp of the data
aid | (optional) Base64 encoded public key of the paired mobile app


### Response
Parameter | Description
--------- | -----------
eventid | Unique eventid generated by service (will be sent to mobile app via FCM)


### Status codes
Code | Meaning
---------- | -------
200 | OK
400 | Bad Request -- Missing arguments.
401 | Unauthorized -- Validation failed.
404 | Not Found -- The specified item could not be found.



<aside class="success">
All registered mobile app to that <code>&lt;eid&gt;</code> will received FCM push notification. Notification is generated by sending this structure:</aside>


```json
{
	"data": {
		"event": {
			"pid": "<pid>",
			"eventid": "<eventid>"
		}
	},
	"to": "<fid>",
	"time_to_live": 60
}
```

Parameter | Description
--------- | -----------
eventid | Unique eventid generated by the service
pid | Pair id (link between eid and aid established during registation process)




<aside class="warning">
Parameters to send as POST data needs to be retrieved from Encedo HEM. Below is an example usecase: Unlock of storage Flash drive</aside>

Encedo HEM request looks like this"

```shell
curl -X POST "https://encedokey.com/api/storage/unlock"
     -H "Content-Type: application/json"     
     -d '{"eid": "jnLU9Bk2XW/J7ExvfID+xq89rIGyONQgO9bpXvCYKhs=", 
          "emp": "i+7QJDUbmmQ2Ek2Xmgq2lXrAQvCL1BGuA1ChfgMGnU4="}'
```

> The above command returns JSON structured like this:

```json
{
	"eat": "1393632408",
	"data": "eyIyRkEiOnsic2VzIjoiWENRUlUwblVuZDYxemlyUkR1ZjVkRTZrSm5BUFBTenJyUjA3a1FYb3JGci9ZRk5OIiwiYWN0IjoiUlVTIn19",
	"sig": "pYszCuBK/iUqhR9VR7ApWamHWoM3dwukWgAFkMt8O58="
}
```

> In the above command JSON object 'data' is a base64 encode JSON embedded command for Mobile App to interpret. For this example will get:

```json
{
	"2FA": {
		"ses": "XCQRU0nUnd61zirRDuf5dE6kJnAPPSzrrR07kQXorFr/YFNN",
		"act": "RUS"
	}
}
```















## Phase 3: Mobile app enquiry

Mobile app via FCM will received unique <code>&lt;eventid&gt;</code>. By calling this endpoint details can be disclosed.

```shell
curl "https://notify.encedo.com/event/98Me6Zf5i...OTYBqFmaLeHZjs/xdA70t7sYLl6ZeMN71FCvJVL2K...O6jtLh7m70C"
```

> The above command returns JSON structured like this:

```json
{
	"emp": "i+7QJDUbmmQ2Ek2Xmgq2lXrAQvCL1BGuA1ChfgMGnU4=",
	"sig": "2ivAugFoMOyAShnurRsgIVvBWHNzuwbzB/iKJnnxmuM=",
	"data": "eyIyRkEiOn...lVTIn19",
	"eat": "1513780490"
}
```

### HTTP Request
`GET https://notify.encedo.com/event/<pid>/<eventid>`


### URL Parameters
Parameter | Description
--------- | -----------
eventid | The ID retrive by FCM push notification
pid | Pair id 


### Response
Parameter | Description
--------- | -----------
emp | Ephemeral session key
data | Payload send by HEM
sig | Signature
eat | Expiration timestamp of the data


### Status codes
Code | Meaning
---------- | -------
200 | OK
404 | Not Found -- The specified item could not be found.



### How to validate data <code>&lt;sig&gt;</code>?

Signature <code>&lt;sig&gt;</code> is generated by Notification Service and have to be verify by mobile app. It is used to validate <code>&lt;data&gt;</code> integrity. Generated is by following formula:

`key = ECDH( Base64Decode(aid_prv), Base64Decode(emp))`

`res = Base64Encode( HMAC(key, data) )`



<aside class="warning">
If parameter <code>&lt;eventid&gt;</code> is omitted (or empty) mobile app will receive PING notification. This is usefull to simulate a.k.a. logon proccess by mobile app after launch.</aside>

```shell
curl "https://notify.encedo.com/event/98Me6Zf5i...OTYBqFmaLeHZjs"
```

> The above command returns JSON structured like this:

```json
{
	"pingid": "OyAShnurRsgIVvBWHNzuwbzB/iKJnnxmuM"
}
```

### HTTP Request
`GET https://notify.encedo.com/event/<pid>`


### URL Parameters
Parameter | Description
--------- | -----------
pid | Pair id


### Response
Parameter | Description
--------- | -----------
pingid | Random ping id that will be sent via FCM as well (to verify if FCM is working properly)


### Status codes
Code | Meaning
---------- | -------
200 | OK
404 | Not Found -- The specified item could not be found.


FCM PING notification is generated by sending this structure:

```json
{
	"data": {
		"ping": {
			"pingid": "<pid>"
		}
	},
	"to": "<fid>",
	"time_to_live": 60
}
```


<aside class="success">
Action performed by Mobile App depends on embedded data in object <code>&lt;data&gt;</code>.</aside>





### How to process <code>&lt;data&gt;</code>?

Example HEM requests to unlock storage drive looks like this:

```json
{
        "2FA": {
                "ses": "XCQRU0nUnd61zirRDuf5dE6kJnAPPSzrrR07kQXorFr/YFNN",
                "act": "USA+"
        }
}
```

Object <code>&lt;act&gt;</code> contain action to perform. Object <code>&lt;ses&gt;</code> is unique session id.

Possible <code>&lt;act&gt;</code> objects (and possible reply):
"RUS" - (Request Storage Unlock) is a request to unlock storage. Possible reply: "USA" (YES, read-only), "USA+" (Yes, writable) or "USD" (NO).

Mobile app based on user chosen replace object <code>&lt;act&gt;</code> by appropriate reply (e.g. "RUS" -> "USA" if user chosed "Yes, read-only). Encdode structre back to base64 and digitally sign (procedure described above).










## Phase 4: Mobile app confirmation

Based on <code>&lt;data&gt;</code> if reply data needs to be returned do HEM, this endpoint can be used. This phase is optional.

```shell
curl -X POST "https://notify.encedo.com/event/98Me6Zf5i...OTYBqFmaLeHZjs/xdA70t7sYLl6ZeMN71FCvJVL2K...O6jtLh7m70C"
     -H "Content-Type: application/json"
     -d '{"sig": "TDP+tvqJIaXYEGoJzETuLIIxAE8O9iv+KbfL0RAkAiE=",
          "data": "eyIyRkEiOnsic2VzIjoid3lNUl...rIn19"}'
```

> The above command returns JSON structured like this:

```json
{
	"status": "posted"
}
```

### HTTP Request
`POST https://notify.encedo.com/event/<pid>/<eventid>`


### URL Parameters
Parameter | Description
--------- | -----------
eventid | The ID retrived by FCM push notification
pid | Pair id


### POST Parameters
Parameter | Description
--------- | -----------
data | Data sent by mobile app to HEM
sig | Signature of the data


### Response
Parameter | Description
--------- | -----------
status | Status of the enquiry


### Status codes
Code | Meaning
---------- | -------
200 | OK
400 | Bad Request -- Missing arguments.
404 | Not Found -- The specified item could not be found.
410 | Gone -- event already handled

### How to generate response <code>&lt;sig&gt;</code>?

Signature <code>&lt;sig&gt;</code> is generated by mobile app and verified by HEM. It is used to validate return <code>&lt;data&gt;</code>. It is generated by the following formula:

`key = ECDH( Base64Decode(aid_prv), Base64Decode(eid))`

`res = Base64Encode( HMAC(key, data) )`

Required <code>&lt;eid&gt;</code> is stored in mobile app available via mapping <code>&lt;pid&gt;</code>. Mobile App after verifying <code>&lt;sig&gt;</code> can begin processing request. Object  <code>&lt;data&gt;</code> after base64 decoding returns embedded JSON structure encoding request type.









## Phase 5: Encedo notify reply gathering

Data returned by mobile app can be gathered by calling this endpoint and reroutig to HEM. This phase is optional.

```shell
curl "https://notify.encedo.com/notify/xdA70t7sYLl6ZeMN71FCvJVL2K...O6jtLh7m70C"
```

> The above command returns JSON structured like this:

```json
{
	"eid": "jnLU9Bk2XW/J7ExvfID+xq89rIGyONQgO9bpXvCYKhs=",
	"aid": "n3StbWfb2YVVFmcDxzGek1RBXE9JS5eZVDVoRc77TFQ=",
	"sig": "uQnEanxiUyNvx6F9eM5gBnG43G8p77bqm\/ANnftDgxI=",
	"data": "eyIyRkEiOn...VU0ErIn19"
}
```

### HTTP Request
`GET https://notify.encedo.com/notify/<eventid>`


### URL Parameters
Parameter | Description
--------- | -----------
eventid | The ID retrive during enquiry of the request


### Response
Parameter | Description
--------- | -----------
eid | Base64 Encedo public key
aid | Base64 encoded Mobile App public key
data | Data sent by mobile app to HEM
sig | Signature of the data


### Status codes
Code | Meaning
---------- | -------
200 | OK
202 | Accepted
404 | Not Found -- The specified item could not be found.


<aside class="warning">
Parameters to be sent as POST data need to be retrieved from Encedo HEM. Below is an example usecase: Unlock of storage Flash drive</aside>

Encedo HEM request looks like this"

```shell
curl -X POST "https://encedokey.com/api/storage/unlock"
     -H "Content-Type: application/json"
     -d '{"eid": "jnLU9Bk2XW/J7ExvfID+xq89rIGyONQgO9bpXvCYKhs=",
          "aid": "n3StbWfb2YVVFmcDxzGek1RBXE9JS5eZVDVoRc77TFQ=",
          "data": "eyIyRkEiOnsic2VzIjoid3lNUlV4ZytiYjUxMDhPclBkMGVcL204K3BcLzJBZURCbWFrZlB5blUyMjU5T0ppUzciLCJhY3QiOiJVU0ErIn19",
          "sig": "uQnEanxiUyNvx6F9eM5gBnG43G8p77bqm\/ANnftDgxI="}'
```


> In the above command JSON object 'data' is a base64 encode JSON embedded command for Mobile App to interpret. For this example will get:

```json
{
	"2FA": {
		"ses": "wyMRUxg+bb5108OrPd0e\/m8+p\/2AeDBmakfPynU2259OJiS7",
		"act": "USA+"
	}
}
```

